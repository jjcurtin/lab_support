---
title: "Resampling demo for CHTC models"
author: "Kendra Wyant"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: html_document
---

Libraries and source functions
```{r}
suppressWarnings(suppressPackageStartupMessages({
  require(dplyr)
  require(vroom) 
  require(tidyr)
  require(stringr)
  require(readr)
})) 

source("../lab_support/chtc/static_files/fun_chtc.R")
```


Create fake data for demo
```{r}
d <- tibble(subid = sort(rep(1:30, times = 10)), x1 = rnorm(300), x2 = rnorm(300), y = rbinom(300,1,.5))
```

## Nested grouped CV
Training control info for nested grouped cv
```{r}
cv_resample_type <- "nested" 
cv_resample <- NULL # NULL because using nested cv
cv_inner_resample <- "1_x_10" # for grouped nested cv - inner will always be kfold
cv_outer_resample <- "1_x_10" 
cv_group <- "subid" 
```

Make splits    
```{r}
set.seed(102030)
splits <- d %>% 
    make_splits(cv_resample_type, cv_resample, cv_outer_resample, cv_inner_resample, cv_group)

splits
```

Check subids are grouped   
Outer groupings
```{r}
# outer groupings for fold 1
out1_train <- training(splits$splits[[1]]) %>%
  glimpse()

out1_test <- testing(splits$splits[[1]]) %>%
  glimpse()

# check no test subids in train set
out1_test %>%
  filter(subid %in% out1_train)
```

Inner groupings
```{r}
# splits for one outer fold
(out1_inners <- splits$inner_resamples[[1]])

# get inner train/test fold 1 for outer fold 2
out2_inner1_train <- training(splits$inner_resamples[[2]]$splits[[1]]) %>%
  glimpse()

out2_inner1_test <- testing(splits$inner_resamples[[2]]$splits[[1]]) %>%
  glimpse()

# check no test subids in train set
out2_inner1_test %>%
  filter(subid %in% out2_inner1_train)
```

## Nested ungrouped CV
Training control info for nested ungrouped cv
```{r}
cv_resample_type <- "nested" 
cv_resample <- NULL 
cv_inner_resample <- "1_x_10" 
cv_outer_resample <- "1_x_10" 
cv_group <- NULL # set to NULL because not using grouping id 
```

Make splits    
```{r}
set.seed(102030)
splits <- d %>% 
    make_splits(cv_resample_type, cv_resample, cv_outer_resample, cv_inner_resample, cv_group)

splits
```

Look at splits
```{r}
# outer groupings for fold 1
out1_train <- training(splits$splits[[1]]) %>%
  glimpse()

out1_test <- testing(splits$splits[[1]]) %>%
  glimpse()

# inner groupings
(out1_inners <- splits$inner_resamples[[1]])

# get inner train/test fold 1 for outer fold 2
out2_inner1_train <- training(splits$inner_resamples[[2]]$splits[[1]]) %>%
  glimpse()

out2_inner1_test <- testing(splits$inner_resamples[[2]]$splits[[1]]) %>%
  glimpse()
```



## Nested CV with inner loop bootstrapping
Training control info for nested cv with bootstrapping
```{r}
cv_resample_type <- "nested" 
cv_resample <- NULL 
cv_inner_resample <- 100
cv_outer_resample <- "1_x_10" 
cv_group <- NULL 
```

Make splits    
```{r}
set.seed(102030)
splits <- d %>% 
    make_splits(cv_resample_type, cv_resample, cv_outer_resample, cv_inner_resample, cv_group)

splits
```

Look at splits
```{r}
# outer groupings for fold 1
out1_train <- training(splits$splits[[1]]) %>%
  glimpse()

out1_test <- testing(splits$splits[[1]]) %>%
  glimpse()

# inner groupings
(out1_inners <- splits$inner_resamples[[1]])

# get inner train/test split 1 for outer fold 2
out2_inner1_train <- training(splits$inner_resamples[[2]]$splits[[1]]) %>%
  glimpse()

out2_inner1_test <- testing(splits$inner_resamples[[2]]$splits[[1]]) %>%
  glimpse()
```


## CV
Training control info for non-nested grouped kfold
```{r}
cv_resample_type <- "kfold" 
cv_resample <- "1_x_10" 
cv_inner_resample <- NULL
cv_outer_resample <- NULL
cv_group <- "subid"
```

Make splits    
```{r}
set.seed(102030)
splits <- d %>% 
    make_splits(cv_resample_type, cv_resample, cv_outer_resample, cv_inner_resample, cv_group)

splits
```

Check splits are grouped
```{r}
split1_train <- training(splits$splits[[1]]) %>% 
  glimpse()

split1_test <- testing(splits$splits[[1]]) %>% 
  glimpse()

# no test subids in train split
split1_test %>% 
  filter(subid %in% split1_train)
```




## Bootstrapping
Training control info for non-nested bootstrapping
```{r}
cv_resample_type <- "boot" 
cv_resample <- "100" 
cv_inner_resample <- NULL
cv_outer_resample <- NULL
cv_group <- NULL
```

Make splits    
```{r}
set.seed(102030)
splits <- d %>% 
    make_splits(cv_resample_type, cv_resample, cv_outer_resample, cv_inner_resample, cv_group)

splits
```


